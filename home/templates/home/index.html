{% load static %}

<!DOCTYPE html>
<html lang="ko">
  <head>
    <title>모바일 캘린더</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@40,400,0,0&icon_names=checklist"
    />
    <link rel="stylesheet" href="{% static 'home/css/calendar.css' %}" />
  </head>
  <body>
    <div class="container">
      <div class="calendar">
        <div class="calendar-header">
          <button class="nav-button" id="prevMonth" aria-label="이전 달">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <h2 id="currentMonth"></h2>
          <button class="nav-button" id="nextMonth" aria-label="다음 달">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>
        </div>

        <div class="weekdays">
          <div class="weekday sunday">일</div>
          <div class="weekday weekday-normal">월</div>
          <div class="weekday weekday-normal">화</div>
          <div class="weekday weekday-normal">수</div>
          <div class="weekday weekday-normal">목</div>
          <div class="weekday weekday-normal">금</div>
          <div class="weekday saturday">토</div>
        </div>

        <div class="days-grid" id="daysGrid"></div>
      </div>
      <div class="selected-date-display" id="selectedDateDisplay">
        <div class="list-item">
          <span class="label">달력에서 날짜를 선택해주세요.</span>
      </div>
    </div>

    <script>
      var data = "{{data|escapejs}}";
      class Calendar {
        constructor() {
          this.currentDate = new Date();
          this.selectedDate = null;
          this.today = new Date();

          this.daysGrid = document.getElementById("daysGrid");
          this.currentMonthEl = document.getElementById("currentMonth");
          this.prevMonthBtn = document.getElementById("prevMonth");
          this.nextMonthBtn = document.getElementById("nextMonth");
          this.selectedDateDisplay = document.getElementById(
            "selectedDateDisplay"
          );

          this.init();
        }

        init() {
          this.prevMonthBtn.addEventListener("click", () =>
            this.goToPreviousMonth()
          );
          this.nextMonthBtn.addEventListener("click", () =>
            this.goToNextMonth()
          );
          this.getExpenseDataByMonth();
        }

        getExpenseDataByMonth() {
          fetch("/home/api/expenseDataByMonth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              year: this.currentDate.getFullYear(),
              month: this.currentDate.getMonth() + 1,
            }),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.status == "success") {
                this.render(JSON.parse(result.data));
              } else {
                console.error("Failed to fetch expense data");
              }
            })
            .catch((error) => {
              console.error("Error fetching expense data:", error);
            });
        }

        goToPreviousMonth() {
          this.currentDate = new Date(
            this.currentDate.getFullYear(),
            this.currentDate.getMonth() - 1,
            1
          );
          this.getExpenseDataByMonth();
        }

        goToNextMonth() {
          this.currentDate = new Date(
            this.currentDate.getFullYear(),
            this.currentDate.getMonth() + 1,
            1
          );
          this.getExpenseDataByMonth();
        }

        getDaysInMonth() {
          const year = this.currentDate.getFullYear();
          const month = this.currentDate.getMonth();

          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);

          const firstDayWeekday = firstDay.getDay();
          const daysInMonth = lastDay.getDate();
          const lastDayWeekday = lastDay.getDay();

          const days = [];

          // 빈 칸 추가
          for (let i = 0; i < firstDayWeekday; i++) {
            days.push(null);
          }

          // 날짜 추가
          for (let i = 1; i <= daysInMonth; i++) {
            days.push(i);
          }

          // 빈 칸 추가
          for (let i = lastDayWeekday; i < 6; i++) {
            days.push(null);
          }

          return days;
        }

        isToday(day) {
          return (
            day === this.today.getDate() &&
            this.currentDate.getMonth() === this.today.getMonth() &&
            this.currentDate.getFullYear() === this.today.getFullYear()
          );
        }

        isSelected(day) {
          if (!this.selectedDate) return false;
          return (
            day === this.selectedDate.getDate() &&
            this.currentDate.getMonth() === this.selectedDate.getMonth() &&
            this.currentDate.getFullYear() === this.selectedDate.getFullYear()
          );
        }

        selectDate(day, button) {
          this.selectedDate = new Date(
            this.currentDate.getFullYear(),
            this.currentDate.getMonth(),
            day
          );

          // 선택된 날짜 표시
          const selectedEls = document.querySelectorAll(".selected");
          selectedEls.forEach((btn) => {
            btn.classList.remove("selected");
          });
          button.classList.add("selected");

          this.getExpenseDataByDay();
          // this.getExpenseDataByMonth();
        }

        updateSelectedDateDisplay(data) {
          if (!this.selectedDate) {
            // this.selectedDateDisplay.classList.remove("show");
            return;
          }

          const options = {
            year: "numeric",
            month: "long",
            day: "numeric",
            weekday: "long",
          };
          // this.selectedDateDisplay.classList.add("show");

          //-----------------------------------------------
          // 수입/지출 데이터 추가
          selectedDateDisplay.innerHTML = "";

          console.log(data);

          data.forEach((row, idx) => {
            var div = document.createElement("div");
            div.className = "list-item";
            if (idx === data.length - 1) {
              div.style.borderBottom = "none";
            }
            div.classList.add(row["type"] === "E" ? "expense" : "income");
            div.innerHTML = `<span class="label">${row["merchant_name"]}</span>`;
            div.innerHTML += `<span class="date ${
              row["type"] === "E" ? "red" : "blue"
            }">${row["amount"].toLocaleString()}원</span>`;

            selectedDateDisplay.appendChild(div);
          });

          if (data.length === 0) {
            var div = document.createElement("div");
            div.className = "list-item";
            div.innerHTML = `<span class="label">선택한 날짜의 수입 / 지출 내역이 없습니다.</span>`;
            selectedDateDisplay.appendChild(div);
          }
        }

        getExpenseDataByDay() {
          if (!this.selectedDate) return;

          fetch("/home/api/expenseDataByDay", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              year: this.selectedDate.getFullYear(),
              month: this.selectedDate.getMonth() + 1,
              day: this.selectedDate.getDate(),
            }),
          })
            .then((response) => response.json())
            .then((result) => {
              // console.log(result);

              if (result.status == "success") {
                this.updateSelectedDateDisplay(JSON.parse(result.data));
              } else {
                console.error("Failed to fetch expense data");
              }
            })
            .catch((error) => {
              console.error("Error fetching expense data:", error);
            });
        }

        render(data) {
          // 월 헤더 업데이트
          const year = this.currentDate.getFullYear();
          const month = this.currentDate.getMonth() + 1;
          this.currentMonthEl.textContent = `${year}년 ${month}월`;

          // 날짜 그리드 렌더링
          const days = this.getDaysInMonth();
          this.daysGrid.innerHTML = "";

          days.forEach((day, index) => {
            const cell = document.createElement("div");
            cell.className = "day-cell";

            // 마지막 줄 처리
            if (index >= days.length - 7) {
              cell.classList.add("last-row");
            }

            if (day === null) {
              this.daysGrid.appendChild(cell);
              return;
            }

            const button = document.createElement("button");
            button.className = "day-button";
            button.textContent = day;

            const dayOfWeek = index % 7;

            // 요일별 색상
            if (dayOfWeek === 0 && !this.isSelected(day)) {
              button.classList.add("sunday");
            } else if (dayOfWeek === 6 && !this.isSelected(day)) {
              button.classList.add("saturday");
            }

            // 오늘 표시
            if (this.isToday(day)) {
              button.classList.add("today");
            }

            button.addEventListener("click", () =>
              this.selectDate(day, button)
            );

            //------------------------------------------------
            // 수입/지출 데이터 추가
            var date_text = `${year}${String(month).padStart(2, "0")}${String(
              day
            ).padStart(2, "0")}`;

            const dayItems = data.filter((item) => item.date === date_text);
            dayItems.forEach((dayItem) => {
              var item_text = document.createElement("div");
              item_text.className =
                "day-text " + (dayItem["type"] === "I" ? "blue" : "red");
              item_text.innerText = dayItem["amount"].toLocaleString();
              button.appendChild(item_text);
            });
            //------------------------------------------------

            cell.appendChild(button);
            this.daysGrid.appendChild(cell);
          });
        }
      }

      // 캘린더 초기화
      calendar = new Calendar();
    </script>
  </body>
</html>
